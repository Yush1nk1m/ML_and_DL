# 케라스 창시자에게 배우는 딥러닝
## 7장, *케라스 완전 정복*

## 7.1 다양한 워크플로

케라스 API 설계는 복잡성의 **단계적 공개**(progressive disclosure) 원칙을 따른다. 시작은 쉽게 하고, 필요할 때 단계마다 점진적으로 학습하여 아주 복잡한 경우를 처리할 수 있다. 누구나 간단한 문제를 처리할 수 있으면서 어떤 고급 워크플로도 가능하다. 즉, 초보자에서 전문가로 성장하면서 동일한 도구를 그대로 사용할 수 있다. 사용 방법만 달라질 뿐이다.

따라서 케라스 모델 사용에 정확히 올바른 하나의 방법이 있는 것이 아니고 유연하게 사용할 수 있다. 모든 워크플로가 동일하게 `Model`, `Layer` 같은 API를 기반으로 하기에 워크플로 간에 호출이 가능하다.



## 7.2 케라스 모델을 만드는 여러 방법

케라스에서 모델을 만드는 방법은 세 가지가 있다.

- **Sequential 모델**: 가장 시작하기 쉬운 API이다. 기본적으로 하나의 파이썬 리스트이기 때문에 층을 쌓을 수만 있다.
- **함수형 API**(functional API): 그래프 같은 모델 구조를 주로 다룬다. 사용성과 유연성 사이의 적절한 중간 지점에 해당된다. 따라서 가장 널리 사용되는 모델 구축 API이다.
- **Model 서브클래싱**(subclassing): 모든 것을 밑바닥부터 구현할 수 있는 가장 저수준의 방법이다. 모든 상세한 내용을 완전히 제어하고 싶은 경우에 적합하지만 여러 가지 케라스 내장 기능을 사용하지 못하기 때문에 실수할 가능성이 크다.

### 7.2.1 Sequential 모델

케라스 모델을 만드는 가장 간단한 방법이다.

**코드 7-1. Sequential 클래스**
```
from tensorflow import keras
from tensorflow.keras import layers

model = keras.Sequential([
    layers.Dense(64, activation="relu"),
    layers.Dense(10, activation="softmax")
])
```

동일한 모델을 `add()` 메소드를 사용해 점진적으로 만들 수도 있다.

**코드 7-2. 점진적으로 Sequential 모델 만들기**
```
model = keras.Sequential()
model.add(layers.Dense(64, activation="relu"))
model.add(layers.Dense(10, activation="softmax"))
```

4장에서 알아본 바와 같이 층은 처음 호출될 때 만들어진다. 층의 가중치 크기가 입력 크기에 따라 달라지기 때문이다. 따라서 앞의 Sequential 모델은 어떤 가중치도 가지고 있지 않다.

**코드 7-3. build() 메소드 호출 전의 모델은 가중치가 없다**
```
>>> model.weights
ValueError: Weights for model 'sequential_1' have not yet been created. Weights are created when the model is first called on inputs or `build()` is called with an `input_shape`.
Output is truncated. View as a scrollable element or open in a text editor. Adjust cell output settings...
```

가중치를 생성하려면 어떤 데이터를 사용해 호출하거나 `build()` 메소드를 호출하여 입력 크기를 직접 지정해야 한다.

**코드 7-4. 가중치를 만들기 위해 모델을 호출한다**
```
>>> model.build(input_shape=(None, 3))
>>> model.weights
[<tf.Variable 'dense_2/kernel:0' shape=(3, 64) dtype=float32, numpy=
 array([[ 0.14485991, -0.19207734,  0.00301257,  0.00564203, -0.2003037 ,
         -0.04069087, -0.03673145,  0.26229954,  0.24616188,  0.01581174,
          0.03658161, -0.23985785,  0.20763212, -0.26009455,  0.2257452 ,
          0.11073321, -0.08046149, -0.18871516,  0.15010571, -0.01123828,
         -0.04747885,  0.07035956, -0.29411757,  0.06580359,  0.05810371,
          0.04807761,  0.15823182,  0.27975678,  0.26390153,  0.2547136 ,
          0.03526282,  0.1512323 , -0.29281834,  0.26212013, -0.04602501,
          0.1381245 ,  0.01172844, -0.00502366,  0.15327391,  0.2831776 ,
          0.12493163, -0.11012411, -0.24750252,  0.26392227, -0.28758195,
         -0.24903813, -0.22205153,  0.07197079, -0.10868582,  0.22222328,
         -0.03826797, -0.2881966 ,  0.05050641,  0.04949784,  0.12121606,
          0.21703112, -0.11255813,  0.06947249, -0.17784923,  0.00337023,
          0.03825685, -0.2860621 ,  0.24071282,  0.07545254],
        [ 0.0132727 , -0.08072604,  0.21542788,  0.10270876, -0.16740084,
         -0.12371565,  0.18598306, -0.22164258, -0.00836241,  0.1760208 ,
          0.12860104,  0.20032847, -0.16698438, -0.13637619,  0.2598145 ,
         -0.18360376, -0.21389788, -0.21184963, -0.08947837, -0.17701876,
          0.04643178,  0.00068694,  0.25474143,  0.09727186, -0.0943014 ,
         -0.1811549 ,  0.07483554,  0.14699018,  0.15854234, -0.05522305,
         -0.04871851, -0.22224703,  0.24921536,  0.01723146, -0.00068259,
          0.12108079,  0.25501966,  0.20947456, -0.28061342,  0.2848066 ,
         -0.2484929 , -0.08790645, -0.03545246, -0.17559594,  0.15264219,
         -0.14418367, -0.07906744, -0.16930538,  0.01421461, -0.12966846,
          0.00444552, -0.12537484,  0.1466229 , -0.13222833, -0.11219049,
...
        [-2.66723335e-01,  2.41590947e-01, -9.45264250e-02,
          1.60042018e-01,  2.16368526e-01,  1.01584792e-01,
         -1.66403294e-01,  6.34652078e-02, -2.50389218e-01,
          2.42061168e-01]], dtype=float32)>,
 <tf.Variable 'dense_3/bias:0' shape=(10,) dtype=float32, numpy=array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], dtype=float32)>]
Output is truncated. View as a scrollable element or open in a text editor. Adjust cell output settings...
```

`build()` 메소드 호출 후에는 디버깅에 유용한 `summary()` 메소드를 사용하여 모델 구조를 출력할 수 있다.

**코드 7-5. summary() 메소드**
```
>>> model.summary()
Model: "sequential_1"
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_2 (Dense)             (None, 64)                256       
                                                                 
 dense_3 (Dense)             (None, 10)                650       
                                                                 
=================================================================
Total params: 906 (3.54 KB)
Trainable params: 906 (3.54 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
```

모델의 이름은 sequential_1로 지정되어 있다. 케라스에서는 모델과 층을 포함한 모든 것의 이름을 지정할 수 있다.

**코드 7-6. name 매개변수로 모델과 층에 이름 지정하기**
```
>>> model = keras.Sequential(name="my_example_model")
>>> model.add(layers.Dense(64, activation="relu", name="my_first_layer"))
>>> model.add(layers.Dense(10, activation="softmax", name="my_last_layer"))
>>> model.build((None, 3))
>>> model.summary()
Model: "my_example_model"
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 my_first_layer (Dense)      (None, 64)                256       
                                                                 
 my_last_layer (Dense)       (None, 10)                650       
                                                                 
=================================================================
Total params: 906 (3.54 KB)
Trainable params: 906 (3.54 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
```

Sequential 모델의 가중치를 바로 생성하는 방법 중 하나는 `Input` 클래스를 사용하여 모델의 입력 크기를 미리 지정하는 것이다.

**코드 7-7. 모델의 입력 크기를 미리 지정하기**
```
model = keras.Sequential()
model.add(keras.Input(shape=(3, )))
model.add(layers.Dense(64, activation="relu"))
```

```
>>> model.summary()
Model: "sequential_2"
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_4 (Dense)             (None, 64)                256       
                                                                 
=================================================================
Total params: 256 (1.00 KB)
Trainable params: 256 (1.00 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________

>>> model.add(layers.Dense(10, activation="softmax"))
>>> model.summary()
Model: "sequential_2"
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_4 (Dense)             (None, 64)                256       
                                                                 
 dense_5 (Dense)             (None, 10)                650       
                                                                 
=================================================================
Total params: 906 (3.54 KB)
Trainable params: 906 (3.54 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
```

### 7.2.2 함수형 API

